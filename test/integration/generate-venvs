#!/bin/bash

echo "BEGIN generate-venvs"

set -eo pipefail

## VERIFY REQUIRED VARS ARE DEFINED
# If any env are undefined, try sourcing the setup script and check again.
# Exits if any required var is undefined.
REQUIRED_VARS="
INSTALL_DIR
CONFIG_DIR
SITE_JAWS_GROUP
SITE_JTM_GROUP
SITE_JTM_WORKER_INSTALL_DIR
SITE_PYTHON
"
RESULT=0
for VAR in $REQUIRED_VARS; do
  if [ -z ${!VAR+xxx} ]; then
    echo "Missing env var, $VAR; sourcing setup script..."
    source ./test/integration/define-env
    RESULT=1
    break
  fi
done
if [[ $RESULT -ne 0 ]]; then
  RESULT=0
  for VAR in $REQUIRED_VARS; do
    if [ -z ${!VAR+xxx} ]; then
      echo "Missing env var: $VAR">&2
      RESULT=1
    fi
  done
fi
[ $RESULT -eq 0 ] || exit 1


## DELETE OLD WHEELS
rm -rf ./*/dist/*

## DELETE OLD VENVS
test -d "$INSTALL_DIR/site" && rm -rf "$INSTALL_DIR/site"
test -d "$INSTALL_DIR/jtm" && rm -rf "$INSTALL_DIR/jtm"
test -d "$INSTALL_DIR/parsl" && rm -rf "$INSTALL_DIR/parsl"
test -d "$SITE_JTM_WORKER_INSTALL_DIR" && rm -rf "$SITE_JTM_WORKER_INSTALL_DIR"


## MAKE VENVS
[[ -n "$SITE_LOAD_PYTHON" ]] && $SITE_LOAD_PYTHON

function create_venv {
  SERVICE_NAME=$1
  VENV_DIR=$2
  $SITE_PYTHON -m venv "$VENV_DIR" && \
  . "$VENV_DIR/bin/activate" && \
  pip install --upgrade pip && \
  pip install rpc/dist/* && \
  pip install $SERVICE_NAME/dist/* && \
  deactivate
}

make pkg
create_venv site "$INSTALL_DIR/site"
create_venv jtm  "$INSTALL_DIR/jtm"
create_venv parsl "$INSTALL_DIR/parsl"
create_venv jtm "$SITE_JTM_WORKER_INSTALL_DIR"

## PERMISSIONS
function fix_perms() {
    local DIR="$1"
    local GROUP=$2
    chmod -R a+rX "$DIR"
    chmod -R ug+rwX "$DIR"
    chgrp -R $GROUP "$DIR"
    find "$DIR" -type d -exec chmod g+s '{}' \;
}
fix_perms "$INSTALL_DIR/site" $SITE_JAWS_GROUP
fix_perms "$INSTALL_DIR/jtm" $SITE_JTM_GROUP
fix_perms "$INSTALL_DIR/parsl" "$SITE_JTM_GROUP"

printf "END generate-venvs\n\n"
