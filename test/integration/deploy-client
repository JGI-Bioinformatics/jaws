#!/usr/bin/env bash

echo "BEGIN deploy-client" 
# NB: this should be run after generate-venvs because it doesn't `make pkg`

## VERIFY REQUIRED VARS ARE DEFINED
# If any env are undefined, try sourcing the setup script and check again.
# Exits if any required var is undefined.
REQUIRED_VARS="
DEPLOYMENT_NAME
INSTALL_DIR
LOGS_DIR
CONFIG_DIR
SITE_CLIENT_INSTALL_DIR
SITE_CLIENT_GROUP
"
RESULT=0
for VAR in $REQUIRED_VARS; do
  if [ -z ${!VAR+xxx} ]; then
    echo "Missing env var, $VAR; sourcing setup script..."
    source ./test/integration/define-env
    RESULT=1
    break
  fi
done
if [[ $RESULT -ne 0 ]]; then
  RESULT=0
  for VAR in $REQUIRED_VARS; do
    if [ -z ${!VAR+xxx} ]; then
      echo "Missing env var: $VAR">&2
      RESULT=1
    fi
  done
fi
[ $RESULT -eq 0 ] || exit 1

function fix_perms() {
    local GROUP="$1"
    local DIR="$2"
    chmod -R a+rX "$DIR"
    chmod -R ug+rwX "$DIR"
    chgrp -R $GROUP "$DIR"
    find "$DIR" -type d -exec chmod g+s '{}' \;
}

## DELETE OLD VENV
test -d "$SITE_CLIENT_INSTALL_DIR" && rm -rf "$SITE_CLIENT_INSTALL_DIR"
mkdir -p "$SITE_CLIENT_INSTALL_DIR"
chmod 755 "$SITE_CLIENT_INSTALL_DIR"

## MAKE VENV
[[ -n "$LOAD_SITE_PYTHON" ]] && $LOAD_SITE_PYTHON
CLIENT_DIST_DIR="client/dist"
make pkg-client
fix_perms "$SITE_CLIENT_GROUP" "$CLIENT_DIST_DIR"
mv "$CLIENT_DIST_DIR" "$SITE_CLIENT_INSTALL_DIR"
echo "Make venv in $SITE_CLIENT_INSTALL_DIR"
$SITE_PYTHON -m venv "$SITE_CLIENT_INSTALL_DIR" && \
  . "$SITE_CLIENT_INSTALL_DIR/bin/activate" && \
  $SITE_PYTHON_PIP install $SITE_CLIENT_INSTALL_DIR/dist/* && \
  deactivate

cat << EOM > $SITE_CLIENT_INSTALL_DIR/jaws-$DEPLOYMENT_NAME.sh
# source this file to activate jaws-$DEPLOYMENT_NAME

source "$SITE_CLIENT_INSTALL_DIR/bin/activate"

export JAWS_CLIENT_CONFIG=$SITE_CLIENT_INSTALL_DIR/jaws-$DEPLOYMENT_NAME.conf
export JAWS_USER_CONFIG=~/jaws.conf

echo "jaws-$DEPLOYMENT_NAME activated; see \"jaws --help\" for more."
EOM
chgrp $SITE_JAWS_GROUP $CONFIG_DIR/jaws-$DEPLOYMENT_NAME.sh
chmod 775 $CONFIG_DIR/jaws-$DEPLOYMENT_NAME.sh
cp "$CONFIG_DIR/jaws-$DEPLOYMENT_NAME.sh" "$SITE_CLIENT_INSTALL_DIR"

## GENERATE CONFIGS
cat << EOM > $SITE_CLIENT_INSTALL_DIR/jaws.conf
[USER]
token = 
staging_dir = 
EOM
chgrp $SITE_JAWS_GROUP $CONFIG_DIR/jaws.conf
chmod 644 $CONFIG_DIR/jaws.conf
cp "$CONFIG_DIR/jaws.conf" "$SITE_CLIENT_INSTALL_DIR"

cat << EOM > $CONFIG_DIR/jaws-$DEPLOYMENT_NAME.conf
[JAWS]
site_id = $JAWS_SITE
name = jaws-$DEPLOYMENT_NAME
url = $JAWS_CENTRAL_HOST:$JAWS_REST_PORT/api/v2
womtool_jar = $SITE_WOMTOOL_JAR
uploads_subdir = $SITE_UPLOADS_SUBDIR
[GLOBUS]
client_id = $JAWS_GLOBUS_CLIENT_ID
endpoint_id = $SITE_GLOBUS_EP
basedir = $SITE_GLOBUS_ROOT_DIR
EOM
chgrp $SITE_JAWS_GROUP $CONFIG_DIR/jaws-$DEPLOYMENT_NAME.conf
chmod 644 $CONFIG_DIR/jaws-$DEPLOYMENT_NAME.conf
cp "$CONFIG_DIR/jaws-$DEPLOYMENT_NAME.conf" "$SITE_CLIENT_INSTALL_DIR"

# at this point, jaws-client is not usable due to permissions, but changing group and permissions via the gitlab-runner
# does not work for parallel-FS for some reason.  The solution is to add such commands to one of the shims so that the
# command are run by the jaws user via supervisord.  This is a hack.  See: jaws-central-daemon shim for more.
printf "END deploy-client\n\n" 
