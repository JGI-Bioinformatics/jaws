swagger: "2.0"

info:
  title: JAWS (JGI Analysis Workflows Service)
  description: Definition of REST API for JGI Analysis Workflows Service
  version: "2.0"
consumes:
  - application/json
produces:
  - application/json
basePath: /api/v2

securityDefinitions:
  oauth2:
    type: oauth2
    flow: implicit
    authorizationUrl: http://localhost:3000/login
    scopes:
      uid: Registered user with unique ID

security:
  - oauth2: ['user']

paths:

  /status:
    get:
      operationId: jaws_central.utils.status
      summary: Status of JAWS services
      responses:
        200:
          description: OK
        500:
          description: System is down
      security: []

  /info:
    get:
      operationId: jaws_central.utils.info
      summary: Information about JAWS deployment
      responses:
        200:
          description: OK
      security: []

  /auth:
    post:
      operationId: jaws_central.auth.save_globus_tokens
      consumes:
        - multipart/form-data
      tags:
        - user
      summary: Save a user's Glbous tokens
      description: Give a user's Globus Auth and Transfer tokens to JAWS
      parameters:
        - name: auth_refresh_token
          in: formData
          type: string
          required: True
          description: Globus Auth Refresh Token
        - name: transfer_refresh_token
          in: formData
          type: string
          required: True
          description: Globus Transfer Refresh Token
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.

  /wdl:
    get:
      operationId: jaws_central.catalog_rest.list_wdls
      tags:
        - workflow
      summary: List shared workflows
      description: List all available workflows
      responses:
        200:
          description: OK
          schema:
            type: array
            properties:
              id:
                type: integer
                description: Unique ID
              name:
                type: string
                description: Workflow name
              version:
                type: string
                description: Workflow version
        401:
          description: Authorization information is missing or invalid.

  /wdl/{name}:
    get:
      operationId: jaws_central.catalog_rest.get_versions
      tags:
        - workflow
      summary: Workflow versions
      description: Returns a workflow's available versions
      parameters:
        - name: name
          in: path
          description: name of the workflow
          type: string
          required: True
      responses:
        200:
          description: OK
          schema:
            type: array
            properties:
              id:
                type: integer
                description: Unique ID
              name:
                type: string
                description: Workflow name
              version:
                type: string
                description: Workflow version
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /wdl/{name}/{version}:
    get:
      operationId: jaws_central.catalog_rest.get_wdl
      tags:
        - workflow
      summary: Return a workflow's WDL file
      description: Returns the workflow specification in WDL or CWL format
      parameters:
        - name: name
          in: path
          description: name of the workflow
          type: string
          required: True
        - name: version
          in: path
          description: version of the workflow
          type: string
          required: True
      produces:
        - text/plain; charset=utf-8
      responses:
        200:
          description: OK
          schema:
            type: file
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

    post:
      operationId: jaws_central.catalog_rest.add_wdl
      consumes:
        - multipart/form-data
      tags:
        - workflow
      summary: Add a workflow WDL
      description: Upload WDL
      parameters:
        - name: wdl_file
          in: formData
          type: file
          required: True
          description: WDL file
        - name: md_file
          in: formData
          type: file
          required: True
          description: Documentation file in markdown format
        - name: name
          in: path
          type: string
          required: True
          description: name of workflow
        - name: version
          in: path
          type: string
          required: True
          description: version of workflow
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.

    put:
      operationId: jaws_central.catalog_rest.update_wdl
      tags:
        - workflow
      summary: Replace a workflow's WDL
      description: Upload WDL
      parameters:
        - name: name
          in: path
          type: string
          required: True
          description: name of workflow
        - name: version
          in: path
          type: string
          required: True
          description: version of workflow
        - name: wdl_file
          in: formData
          type: file
          required: False
          description: new WDL file
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified workflow does not exist.

    delete:
      operationId: jaws_central.catalog_rest.del_wdl
      tags:
        - workflow
      summary: Delete a workflow
      description: Delete a specific version of a workflow
      parameters:
        - name: name
          in: path
          type: string
          required: True
          description: name of workflow
        - name: version
          in: path
          type: string
          required: True
          description: version of workflow
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified workflow does not exist.

  /wdl/{name}/{version}/doc:
    get:
      operationId: jaws_central.catalog_rest.get_doc
      tags:
        - workflow
      summary: Return information about a workflow
      description: Returns the workflow's description
      parameters:
        - name: name
          in: path
          description: name of the workflow
          type: string
          required: True
        - name: version
          in: path
          description: version of the workflow
          type: string
          required: True
      produces:
        - text/html
      responses:
        200:
          description: OK
          schema:
            type: file
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

    put:
      operationId: jaws_central.catalog_rest.update_doc
      tags:
        - workflow
      summary: Update a workflow's documentation
      description: Replaces the doc file for a workflow
      parameters:
        - name: name
          in: path
          description: name of the workflow
          type: string
          required: True
        - name: version
          in: path
          description: version of the workflow
          type: string
          required: True
        - name: md_file
          in: formData
          description: New doc file in markdown format
          type: file
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /wdl/{name}/{version}/release:
    put:
      operationId: jaws_central.catalog_rest.release_wdl
      tags:
        - workflow
      summary: Mark a Workflow as Released
      description: Released Workflows are immutable.
      parameters:
        - name: name
          in: path
          description: name of the workflow
          type: string
          required: True
        - name: version
          in: path
          description: version of the workflow
          type: string
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /search:
    get:
      operationId: jaws_central.analysis.user_queue
      tags:
        - search
      summary: Search for current user's unfinished runs
      description: Return runs in Submitted, Queued, Running, or Transferring states.
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.

  /search/{delta_days}:
    get:
      operationId: jaws_central.analysis.user_history
      tags:
        - search
      summary: Get a user's recent runs
      description: Returns a user's runs within the last specified number of days
      parameters:
        - name: delta_days
          description: time window to search
          type: integer
          in: path
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.

  /run:
    post:
      operationId: jaws_central.analysis.submit_run
      consumes:
        - multipart/form-data
      tags:
        - run
      summary: Begin run run process
      description: Returns site information to send infiles.
      parameters:
        - name: site_id
          description: computing site to use
          type: string
          in: formData
          required: True
        - name: submission_id
          description: UUID used to name inputs
          type: string
          in: formData
          required: True
        - name: input_site_id
          description: ID of the Site where the input data is stored
          type: string
          in: formData
          required: True
        - name: input_endpoint
          description: Globus endpoint ID where the input data is stored
          type: string
          in: formData
          required: True
        - name: output_endpoint
          description: Globus endpoint ID where to send results
          type: string
          in: formData
          required: True
        - name: output_dir
          description: Folder to write results
          type: string
          in: formData
          required: True
      responses:
        201:
          description: Successful
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The requested site does not exist

  /run/{run_id}:
    get:
      operationId: jaws_central.analysis.run_status
      tags:
        - run
      summary: Retrieve the status of a specified run
      description: Summarize the state of a particular run
      parameters:
        - name: run_id
          in: path
          description: run_id of the run to retrieve
          type: integer
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /run/{run_id}/task_status:
    get:
      operationId: jaws_central.analysis.task_status
      tags:
        - run
      summary: Retrieve a summary of a run's tasks
      description: Return Cromwell status for each task
      parameters:
        - name: run_id
          in: path
          description: run_id of the run to retrieve
          type: integer
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /run/{run_id}/cancel:
    put:
      operationId: jaws_central.analysis.cancel_run
      tags:
        - run
      summary: Cancel a run
      description: Abort the execution of a run
      parameters:
        - name: run_id
          in: path
          type: integer
          required: True
      responses:
        201:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /run/{run_id}/metadata:
    get:
      operationId: jaws_central.analysis.run_metadata
      tags:
        - run
      summary: Retrieve the metadata of a specified run
      description: Return assorted information about a run
      parameters:
        - name: run_id
          in: path
          description: run_id of the run to retrieve
          type: integer
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /run/{run_id}/run_log:
    get:
      operationId: jaws_central.analysis.run_log
      tags:
        - run
      summary: Retrieve the run logs of a specified run
      description: Return log of a Run's state transitions
      parameters:
        - name: run_id
          in: path
          description: run_id of the run to retrieve
          type: integer
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /run/{run_id}/task_log:
    get:
      operationId: jaws_central.analysis.task_log
      tags:
        - run
      summary: Retrieve the task logs of a specified run
      description: Return log of all Tasks' state transitions
      parameters:
        - name: run_id
          in: path
          description: run_id of the run to retrieve
          type: integer
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /run/{run_id}/output:
    get:
      operationId: jaws_central.analysis.output
      tags:
        - run
      summary: Retrieve Task output
      description: Return stdout/stderr output of all Tasks
      parameters:
        - name: run_id
          in: path
          description: run_id of the run to retrieve
          type: integer
          required: True
      produces:
        - text/plain; charset=utf-8
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /run/{run_id}/failed:
    get:
      operationId: jaws_central.analysis.failed_output
      tags:
        - run
      summary: Retrieve the output for failed tasks
      description: Return stdout/stderr/submit output for failed tasks
      parameters:
        - name: run_id
          in: path
          description: run_id of the run to retrieve
          type: integer
          required: True
      produces:
        - text/plain; charset=utf-8
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /site:
    get:
      operationId: jaws_central.analysis.list_sites
      tags:
        - site
      summary: Retrieve summary of all JAWS-Sites
      description: List all Sites
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.

  /site/{site_id}:
    get:
      operationId: jaws_central.analysis.get_site
      tags:
        - site
      summary: Retrieve JAWS-Site info
      description: Return Site parameters
      parameters:
        - name: site_id
          in: path
          description: JAWS-Site ID
          type: string
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist
        503:
          description: The requested Site is currently unavailable
