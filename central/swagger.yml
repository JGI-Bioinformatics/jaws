swagger: "2.0"

info:
  title: JAWS (JGI Analysis Workflows Service)
  description: Definition of REST API for JGI Analysis Workflows Service
  version: "2.0"
consumes:
  - application/json
produces:
  - application/json
basePath: /api/v2

securityDefinitions:
  oauth2:
    type: oauth2
    flow: implicit
    authorizationUrl: http://localhost:8080/login
    x-tokenInfoUrl: http://localhost:8080/tokeninfo
    scopes:
      uid: Registered user with unique ID

security:
  - oauth2: ['jaws_users']

paths:

  /status:
    get:
      operationId: utils.status
      responses:
        200:
          description: OK
        500:
          description: System is down
#      security: []

#  /user:
#    get:
#      operationId: user.get_info
#      tags:
#        - user
#      summary: Retrieve user basic info given token
#      description: Validate user token and return basic info
#      responses:
#        200:
#          description: OK
#        401:
#          description: Authorization information is missing or invalid.
#
#  /user:
#    post:
#      operationId: user.save_tokens
#      tags:
#        - user
#      summary: Save user's Globus tokens
#      description: Give JAWS user's Globus token
#      consumes:
#        - multipart/form-data
#      parameters:
#        - name: auth_access_token
#          description: Globus auth access_token
#          type: string
#          in: formData
#          required: True
#        - name: auth_refresh_token
#          description: Globus auth refresh_token
#          type: string
#          in: formData
#          required: True
#        - name: auth_expires_at_seconds
#          description: Globus auth expires_at_seconds
#          type: integer
#          in: formData
#          required: True
#        - name: transfer_access_token
#          description: Globus transfer access_token
#          type: string
#          in: formData
#          required: True
#        - name: transfer_refresh_token
#          description: Globus transfer refresh_token
#          type: string
#          in: formData
#          required: True
#        - name: transfer_expires_at_seconds
#          description: Globus transfer expires_at_seconds
#          type: integer
#          in: formData
#          required: True
#        - name: groups_access_token
#          description: Globus groups access_token
#          type: string
#          in: formData
#          required: True
#        - name: groups_refresh_token
#          description: Globus groups refresh_token
#          type: string
#          in: formData
#          required: True
#        - name: groups_expires_at_seconds
#          description: Globus groups expires_at_seconds
#          type: integer
#          in: formData
#          required: True
#      responses:
#        200:
#          description: OK
#        401:
#          description: Authorization information is missing or invalid.

  /wdl:
    get:
      operationId: catalog.list_wdls
      tags:
        - workflow
      summary: List shared workflows
      description: List all available workflows
      responses:
        200:
          description: OK
          schema:
            type: array
            properties:
              id:
                type: integer
                description: Unique ID
              name:
                type: string
                description: Workflow name
              version:
                type: string
                description: Workflow version
        401:
          description: Authorization information is missing or invalid.

  /wdl/{name}:
    get:
      operationId: catalog.get_versions
      tags:
        - workflow
      summary: Workflow versions
      description: Returns a workflow's available versions
      parameters:
        - name: name
          in: path
          description: name of the workflow
          type: string
          required: True
      responses:
        200:
          description: OK
          schema:
            type: array
            properties:
              id:
                type: integer
                description: Unique ID
              name:
                type: string
                description: Workflow name
              version:
                type: string
                description: Workflow version
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /wdl/{name}/{version}:
    get:
      operationId: catalog.get_wdl
      tags:
        - workflow
      summary: Return a workflow's WDL file
      description: Returns the workflow specification in WDL or CWL format
      parameters:
        - name: name
          in: path
          description: name of the workflow
          type: string
          required: True
        - name: version
          in: path
          description: version of the workflow
          type: string
          required: True
      produces:
        - text/plain; charset=utf-8
      responses:
        200:
          description: OK
          schema:
            type: file
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

    post:
      operationId: catalog.add_wdl
      tags:
        - workflow
      summary: Add a workflow WDL
      description: Upload WDL
      parameters:
        - name: wdl_file
          in: formData
          type: file
          required: True
          description: WDL file
        - name: md_file
          in: formData
          type: file
          required: True
          description: Documentation file in markdown format
        - name: name
          in: path
          type: string
          required: True
          description: name of workflow
        - name: version
          in: path
          type: string
          required: True
          description: version of workflow
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.

    put:
      operationId: catalog.update_wdl
      tags:
        - workflow
      summary: Replace a workflow's WDL
      description: Upload WDL
      parameters:
        - name: name
          in: path
          type: string
          required: True
          description: name of workflow
        - name: version
          in: path
          type: string
          required: True
          description: version of workflow
        - name: wdl_file
          in: formData
          type: file
          required: False
          description: new WDL file
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified workflow does not exist.

    delete:
      operationId: catalog.del_wdl
      tags:
        - workflow
      summary: Delete a workflow
      description: Delete a specific version of a workflow
      parameters:
        - name: name
          in: path
          type: string
          required: True
          description: name of workflow
        - name: version
          in: path
          type: string
          required: True
          description: version of workflow
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified workflow does not exist.

  /wdl/{name}/{version}/doc:
    get:
      operationId: catalog.get_doc
      tags:
        - workflow
      summary: Return information about a workflow
      description: Returns the workflow's description
      parameters:
        - name: name
          in: path
          description: name of the workflow
          type: string
          required: True
        - name: version
          in: path
          description: version of the workflow
          type: string
          required: True
      produces:
        - text/html
      responses:
        200:
          description: OK
          schema:
            type: file
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

    put:
      operationId: catalog.update_doc
      tags:
        - workflow
      summary: Update a workflow's documentation
      description: Replaces the doc file for a workflow
      parameters:
        - name: name
          in: path
          description: name of the workflow
          type: string
          required: True
        - name: version
          in: path
          description: version of the workflow
          type: string
          required: True
        - name: md_file
          in: formData
          description: New doc file in markdown format
          type: file
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /run:
    get:
      operationId: analysis.user_queue
      tags:
        - run
      summary: Search for current user's unfinished runs
      description: Return runs in Submitted, Queued, Running, or Transferring states.
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.

    post:
      operationId: analysis.submit_run
      tags:
        - run
      summary: Begin run run process
      description: Returns site information to send infiles.
      consumes:
        - multipart/form-data
      parameters:
        - name: site
          description: computing site to use
          type: string
          in: formData
          required: True
        - name: submission_uuid
          description: random ID used to name inputs
          type: string
          in: formData
          required: True
        - name: transfer_task_id
          description: Globus task id
          type: string
          in: formData
          required: True
        - name: globus_endpoint
          description: Globus endpoint to receive results
          type: string
          in: formData
          required: True
        - name: outdir
          description: Folder to receive results
          type: string
          in: formData
          required: True
      responses:
        201:
          description: Successful
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The requested site does not exist

  /run/{run_id}:
    get:
      operationId: analysis.run_status
      tags:
        - run
      summary: Retrieve the status of a specified run
      description: Summarize the state of a particular run
      parameters:
        - name: run_id
          in: path
          description: run_id of the run to retrieve
          type: integer
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

    delete:
      operationId: analysis.cancel_run
      tags:
        - run
      summary: Cancel a run and purge it's output
      description: Purging prevents reuse by cache
      parameters:
        - name: run_id
          in: path
          type: integer
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist

  /run/{run_id}/metadata:
    get:
      operationId: analysis.run_metadata
      tags:
        - run
      summary: Retrieve the metadata of a specified run
      description: Return assorted information about a run
      parameters:
        - name: run_id
          in: path
          description: run_id of the run to retrieve
          type: integer
          required: True
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist


  /run/get_site:
    post:
      operationId: analysis.get_site
      tags:
        - run
      summary: Retrieve JAWS-Site info
      description: Match run to a Site and return necessary info
      parameters:
        - name: site
          in: formData
          description: Preferred JAWS-Site name
          type: string
          required: False
        - name: max_ram_gb
          in: formData
          description: Max RAM required by workflow, in gigabytes
          type: integer
          required: False
        - name: transfer_gb
          in: formData
          description: Amount of input data to be transferred
          type: integer
          required: False
      responses:
        200:
          description: OK
        401:
          description: Authorization information is missing or invalid.
        404:
          description: The specified record does not exist
        503:
          description: The requested Site is currently unavailable
