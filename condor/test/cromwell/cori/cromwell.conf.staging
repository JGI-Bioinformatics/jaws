include required(classpath("application"))
webservice
{
  port = 50102
  interface = 127.0.0.1
}
system
{
  abort-jobs-on-terminate = true
  graceful-server-shutdown = true
  workflow-restart = false
  max-concurrent-workflows = 100000
  max-workflow-launch-count = 100000
  new-workflow-poll-rate = 1
  number-of-workflow-log-copy-workers = 20
  number-of-cache-read-workers = 50
  job-rate-control
  {
    jobs = 1
    per = 1 second
  }
}
workflow-options
{
  workflow-log-dir: "/global/cfs/projectdirs/jaws/jaws-install/jaws-staging/logs/cromwell-workflow-logs"
  workflow-log-temporary: false
  workflow-failure-mode: "ContinueWhilePossible"
  default
  {
    workflow-type: WDL
    workflow-type-version: "draft-2"
  }
}
call-caching
{
  enabled = true
  invalidate-bad-cache-result = true
}
# this is required for shifter to find image from its registry.
docker {
    hash-lookup {
        enabled = false
    }
}
backend
{
  default = "HtCondor"
  providers
  {
    LOCAL
    {
      actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"
      config {
        concurrent-job-limit = 0
      }
    }
    JTM
    {
      actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"
      config {
        exit-code-timeout-seconds = 60
        runtime-attributes = """
          String? docker
          String time = "00:30:00"
          Int cpu = 32
          Float? memory_gb = 5
          String cluster = "cori"
          String poolname = "small"
          String constraint = "haswell"
          String qos = "genepool_special"
          String account = "fungalp"
          String partition = ""
          Int node = 1
          Int nwpn = 1
          Int shared = 0
        """

        filesystems {
          local {
            localization: [ "hard-link", "copy" ]
            caching {
              duplication-strategy: [ "hard-link", "copy" ]
              hashing-strategy: "xxh64"
            }
            http {}
          }
        }

        kill = "jtm --config=/global/cfs/projectdirs/jaws/jaws-install/jaws-staging/configs/jaws-jtm.conf kill -tid ${job_id}"
        check-alive = "jtm --config=/global/cfs/projectdirs/jaws/jaws-install/jaws-staging/configs/jaws-jtm.conf isalive -tid ${job_id}"
        job-id-regex = "JTM task ID (\\d+)"

        submit = """
          CONSTRAINT=${constraint}
          QOS=${qos}
          PARTITION=${partition}
          [ -z $QOS ] || QOS="--qos $QOS"
          [ -z $CONSTRAINT ] || CONSTRAINT="-C $CONSTRAINT"
          [ -z $PARTITION ] || PARTITION="-P $PARTITION"
          jtm --config=/global/cfs/projectdirs/jaws/jaws-install/jaws-staging/configs/jaws-jtm.conf           submit           -cmd '/bin/bash ${script}'           -cl ${cluster}           -t ${time}           -c ${cpu}           -m ${memory_gb}           -p ${poolname}           -N ${node}           -nwpn ${nwpn}           -jid ${job_name}           -A ${account}           --shared ${shared}           $CONSTRAINT           $QOS           $PARTITION
        """

        submit-docker = """

          CONSTRAINT=${constraint}
          QOS=${qos}
          PARTITION=${partition}
          [ -z $QOS ] || QOS="--qos $QOS"
          [ -z $CONSTRAINT ] || CONSTRAINT="-C $CONSTRAINT"
          [ -z $PARTITION ] || PARTITION="-P $PARTITION"
          jtm --config=/global/cfs/projectdirs/jaws/jaws-install/jaws-staging/configs/jaws-jtm.conf           submit           -cmd "/global/cfs/projectdirs/jaws/jaws-install/jaws-staging/shifter_exec.sh ${docker} /global/dna/shared/databases/jaws/refdata /refdata ${job_shell} ${script}"           -cl ${cluster}           -t ${time}           -c ${cpu}           -m ${memory_gb}           -p ${poolname}           -N ${node}           -nwpn ${nwpn}           -jid ${job_name}           -A ${account}           --shared ${shared}           $QOS           $CONSTRAINT           $PARTITION
        """

        # Root directory where Cromwell writes job results in the container. This value
        # can be used to specify where the execution folder is mounted in the container.
        # it is used for the construction of the docker_cwd string in the submit-docker
        # value above AND in the generation of the "script" file.
        dockerRoot = /global/cscratch1/sd/jaws_jtm/jaws-staging/cromwell-executions
      }
    }
    HtCondor {
      actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"

      config
      {
        #exit-code-timeout-seconds = 60
        runtime-attributes = """
          String? docker
          String? docker_user
          Int? cpu = 1
          Float? memory_mb = 512
          Float? disk_kb = 25600.0
          Int? runtime_minutes
          String? nativeSpecs
          String? priority
        """
        submit = """
          export CONDOR_CONFIG="/global/cfs/projectdirs/jaws/condor/condor_central.config"
          PATH="/global/cfs/projectdirs/jaws/condor/condor/bin":"/global/cfs/projectdirs/jaws/condor/condor/sbin":/usr/common/software/python/3.8-anaconda-2020.11/bin:/global/homes/j/jaws/.local/cori/3.8-anaconda-2020.11/bin:/opt/cray/pe/mpt/7.7.19/gni/bin:/opt/cray/pe/perftools/21.12.0/bin:/opt/cray/pe/papi/6.0.0.12/bin:/opt/cray/rca/2.2.20-7.0.3.1_3.7__g8e3fb5b.ari/bin:/opt/cray/alps/6.6.67-7.0.3.1_3.7__gb91cd181.ari/sbin:/opt/cray/alps/default/bin:/opt/cray/pe/craype/2.7.10/bin:/opt/intel/compilers_and_libraries_2020.2.254/linux/bin/intel64:/global/common/cori_cle7up03/software/darshan/3.3.1/bin:/global/common/cori_cle7up03/software/bin:/opt/ovis/bin:/opt/ovis/sbin:/opt/cray/pe/modules/3.2.11.4/bin:/usr/local/bin:/usr/bin:/bin:/usr/lib/mit/bin:/usr/lib/mit/sbin:/opt/cray/pe/bin
          chmod 755 ${script}
          #printenv > env.debug
          cat > ${cwd}/execution/submitFile <<EOF
PATH="/global/cfs/projectdirs/jaws/condor/condor/bin":"/global/cfs/projectdirs/jaws/condor/condor/sbin":/usr/common/software/python/3.8-anaconda-2020.11/bin:/global/homes/j/jaws/.local/cori/3.8-anaconda-2020.11/bin:/opt/cray/pe/mpt/7.7.19/gni/bin:/opt/cray/pe/perftools/21.12.0/bin:/opt/cray/pe/papi/6.0.0.12/bin:/opt/cray/rca/2.2.20-7.0.3.1_3.7__g8e3fb5b.ari/bin:/opt/cray/alps/6.6.67-7.0.3.1_3.7__gb91cd181.ari/sbin:/opt/cray/alps/default/bin:/opt/cray/pe/craype/2.7.10/bin:/opt/intel/compilers_and_libraries_2020.2.254/linux/bin/intel64:/global/common/cori_cle7up03/software/darshan/3.3.1/bin:/global/common/cori_cle7up03/software/bin:/opt/ovis/bin:/opt/ovis/sbin:/opt/cray/pe/modules/3.2.11.4/bin:/usr/local/bin:/usr/bin:/bin:/usr/lib/mit/bin:/usr/lib/mit/sbin:/opt/cray/pe/bin
Iwd=${cwd}/execution
+Owner=UNDEFINED
request_memory=${memory_mb}
request_disk=${disk_kb}
request_cpus=${cpu}
error=${cwd}/execution/stderr
output=${cwd}/execution/stdout
log_xml=true
executable=${script}
log=${cwd}/execution/execution.log
queue
EOF
          condor_submit ${cwd}/execution/submitFile
        """
        submit-docker = """
          export CONDOR_CONFIG="/global/cfs/projectdirs/jaws/condor/condor_central.config"
          PATH="/global/cfs/projectdirs/jaws/condor/condor/bin":"/global/cfs/projectdirs/jaws/condor/condor/sbin":/usr/common/software/python/3.8-anaconda-2020.11/bin:/global/homes/j/jaws/.local/cori/3.8-anaconda-2020.11/bin:/opt/cray/pe/mpt/7.7.19/gni/bin:/opt/cray/pe/perftools/21.12.0/bin:/opt/cray/pe/papi/6.0.0.12/bin:/opt/cray/rca/2.2.20-7.0.3.1_3.7__g8e3fb5b.ari/bin:/opt/cray/alps/6.6.67-7.0.3.1_3.7__gb91cd181.ari/sbin:/opt/cray/alps/default/bin:/opt/cray/pe/craype/2.7.10/bin:/opt/intel/compilers_and_libraries_2020.2.254/linux/bin/intel64:/global/common/cori_cle7up03/software/darshan/3.3.1/bin:/global/common/cori_cle7up03/software/bin:/opt/ovis/bin:/opt/ovis/sbin:/opt/cray/pe/modules/3.2.11.4/bin:/usr/local/bin:/usr/bin:/bin:/usr/lib/mit/bin:/usr/lib/mit/sbin:/opt/cray/pe/bin

          #printenv > env.debug
          cat > ${cwd}/execution/dockerScript <<EOF
#!/bin/bash
PATH="/global/cfs/projectdirs/jaws/condor/condor/bin":"/global/cfs/projectdirs/jaws/condor/condor/sbin":/usr/common/software/python/3.8-anaconda-2020.11/bin:/global/homes/j/jaws/.local/cori/3.8-anaconda-2020.11/bin:/opt/cray/pe/mpt/7.7.19/gni/bin:/opt/cray/pe/perftools/21.12.0/bin:/opt/cray/pe/papi/6.0.0.12/bin:/opt/cray/rca/2.2.20-7.0.3.1_3.7__g8e3fb5b.ari/bin:/opt/cray/alps/6.6.67-7.0.3.1_3.7__gb91cd181.ari/sbin:/opt/cray/alps/default/bin:/opt/cray/pe/craype/2.7.10/bin:/opt/intel/compilers_and_libraries_2020.2.254/linux/bin/intel64:/global/common/cori_cle7up03/software/darshan/3.3.1/bin:/global/common/cori_cle7up03/software/bin:/opt/ovis/bin:/opt/ovis/sbin:/opt/cray/pe/modules/3.2.11.4/bin:/usr/local/bin:/usr/bin:/bin:/usr/lib/mit/bin:/usr/lib/mit/sbin:/opt/cray/pe/bin
/global/cfs/projectdirs/jaws/jaws-install/jaws-staging/shifter_exec.sh ${docker} /global/dna/shared/databases/jaws/refdata /refdata ${job_shell} ${script}
EOF
          chmod 755 ${cwd}/execution/dockerScript
          cat > ${cwd}/execution/submitFile <<EOF
Iwd=${cwd}/execution
+Owner=UNDEFINED
request_memory=${memory_mb}
request_disk=${disk_kb}
request_cpus=${cpu}
error=${cwd}/execution/stderr
output=${cwd}/execution/stdout
log_xml=true
executable=${cwd}/execution/dockerScript
log=${cwd}/execution/execution.log
queue
EOF
          condor_submit ${cwd}/execution/submitFile
       """
        kill = "export CONDOR_CONFIG=/global/cfs/projectdirs/jaws/condor/condor_central.config && /global/cfs/projectdirs/jaws/condor/condor/bin/condor_rm ${job_id}"
        check-alive = "export CONDOR_CONFIG=/global/cfs/projectdirs/jaws/condor/condor_central.config && /global/cfs/projectdirs/jaws/condor/condor/bin/condor_q ${job_id}"
        job-id-regex = "(?sm).*cluster (\\d+)..*"
        root = /global/cscratch1/sd/jaws_jtm/jaws-staging/cromwell-executions
        dockerRoot = /global/cscratch1/sd/jaws_jtm/jaws-staging/cromwell-executions
      }
    }
  }
}
database
{
  profile = "slick.jdbc.MySQLProfile$"
  db
  {
    driver = "com.mysql.cj.jdbc.Driver"
    url = "jdbc:mysql://jaws-db.lbl.gov:3306/cromwell_cori_staging?rewriteBatchedStatements=true&useSSL=false&autoReconnect=true&useUnicode=true&useJDBCCompliantTimezoneShift=true&useLegacyDatetimeCode=false&serverTimezone=UTC"
    user = "jaws"
    password = "MBQG0!7jAxk1M2R6Ufh"
    connectionTimeout = 5000
  }
  insert-batch-size = 2000
}
