include required(classpath("application"))

webservice
{
  port = 50010
}

system
{
  abort-jobs-on-terminate = false
  graceful-server-shutdown = true
  workflow-restart = true
  max-concurrent-workflows = 100000
  max-workflow-launch-count = 100000
  new-workflow-poll-rate = 1
  number-of-workflow-log-copy-workers = 20
  number-of-cache-read-workers = 50
}

workflow-options
{
  workflow-log-dir: "/global/scratch/jaws/dev/cromwell-workflow-logs"
  workflow-log-temporary: false
  workflow-failure-mode: "ContinueWhilePossible"
  default
  {
    workflow-type: WDL
    workflow-type-version: "draft-2"
  }
}

call-caching
{
  enabled = true
  invalidate-bad-cache-result = true
}

#docker {
#    hash-lookup {
#    enabled = false
#    }
#}

backend
{
  default = "slurm"

  providers
  {

    Local
    {
      actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"

      config
      {
        concurrent-job-limit = 7
        run-in-background = true
        #temporary-directory = "`mktemp -d \"/global/scratch/jaws/dev/cromwell-tmp\"/tmp.XXXXXX`"

        # The list of possible runtime custom attributes.
        runtime-attributes = """
        String? docker
        """

        # Submit string when there is no "docker" runtime attribute.
        submit = "/usr/bin/env bash ${script}"

        # Submit string when there is a "docker" runtime attribute.
        submit-docker = "./singularity_exec.sh ${cwd} ${docker_cwd} ${docker} ${job_shell} ${script}"

        root = "${cwd}/cromwell-executions"
        dockerRoot = "/cromwell-executions"

        filesystems
        {
          local
          {
            localization: [ "soft-link", "copy" ]

            caching {
              duplication-strategy: [ "hard-link", "soft-link", "copy" ]
              hashing-strategy: "file"
            }
          }
        }

        default-runtime-attributes
        {
          failOnStderr: false
          continueOnReturnCode: 0
        }
      }
    }


    slurm {
        # Documentation
        # https://cromwell.readthedocs.io/en/develop/tutorials/Containers/#job-schedulers

        actor-factory = "cromwell.backend.impl.sfs.config.ConfigBackendLifecycleActorFactory"                                                                                     
        config {
            runtime-attributes = """
                String time = "00:00:00"
                Int cpu = 1 
                String mem = "0G"
                String cluster = "jaws_lbl_gov"
                String poolname = "small"
                String constraint = "haswell"
                String qos = "condo_jgicloud"
                String account = "lr_jgicloud"
                Int node = 1 
                Int nwpn = 1 
                Int shared = 1 
                String? docker
                String job_name = "slurm-test"
            """

        submit = """
            sbatch \
              --wait \
              -J ${job_name} \
              -D ${cwd} \
              -o ${out} \
              -e ${err} \
              -t ${time} \
              ${"-c " + cpu} \
              --mem=${mem} \
              --wrap "/bin/bash ${script}"
        """

        submit-docker = """
            # Ensure singularity is loaded if it's installed as a module
            module load Singularity/3.0.1

            # Build the Docker image into a singularity image
            IMAGE=${cwd}/${docker}.sif
            singularity build $IMAGE docker://${docker}

            # Submit the script to SLURM
            sbatch \
              --wait \
              -J ${job_name} \
              -D ${cwd} \
              -o ${cwd}/execution/stdout \
              -e ${cwd}/execution/stderr \
              -t ${time} \
              ${"-c " + cpu} \
              --mem=${mem} \
              --wrap singularity exec --bind ${cwd}:${docker_cwd} docker://${docker} ${job_shell} ${script}
        """
        root = "${cwd}/cromwell-executions"
        dockerRoot = "/cromwell-executions"

        kill = "scancel ${job_id}"
        check-alive = "squeue -j ${job_id}"
        job-id-regex = "Submitted batch job (\\d+).*"
      }
    }
  }
}

database
{
  profile = "slick.jdbc.MySQLProfile$"
  db
  {
    #driver = "com.mysql.jdbc.Driver"
    driver = "com.mysql.cj.jdbc.Driver"
    url = "jdbc:mysql://jaws-db.lbl.gov:3306/cromwell_dev?rewriteBatchedStatements=true&autoReconnect=true"
    user = "cromwell_dev"
    password = "7f7VG1d^rD1hS9mwW0R"
    connectionTimeout = 10000
  }
  insert-batch-size = 2000
}
